<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Screen Share (Firebase Signaling)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
        --bg-primary: #17181a;
        --bg-secondary: #202225;
        --bg-tertiary: #2c2f33;
        --bg-code: #101214;
        --bg-hover: #35383c;
        --text-primary: #f0f2f5;
        --text-secondary: #a8b3cf;
        --text-active: #82aaff;
        --border-color: #3a3d42;
        --success-color: #57ab5a;
        --font-family: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      overflow: hidden;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-family);
      font-size: 16px;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    .main-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 24px;
      background-color: rgba(23, 24, 26, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
      z-index: 100;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .content-area {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow: auto;
    }
    
    .content-wrapper {
        width: 100%;
        max-width: 960px;
        margin: auto;
    }

    /* --- Control Section Styles --- */
    .controls-container {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 32px;
        text-align: center;
    }

    #join-controls { display: none; }
    #broadcast-status { display: none; }

    .controls-container h2 {
        font-size: 1.75rem;
        margin-bottom: 16px;
    }
    .controls-container p {
        color: var(--text-secondary);
        margin-bottom: 32px;
        font-size: 1.1rem;
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: center;
    }

    .btn {
        padding: 14px 28px;
        font-weight: 600;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
    }
    .btn:active { transform: translateY(1px); }

    .btn-primary { background-color: var(--text-active); color: var(--bg-primary); }
    .btn-primary:hover { opacity: 0.9; }
    
    .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: var(--bg-hover); }

    .input-group {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
    }
    #roomIDInput {
        flex-grow: 1;
        background-color: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 14px 18px;
        font-size: 1.2rem;
        text-align: center;
        letter-spacing: 4px;
        color: var(--text-primary);
        outline: none;
    }
    #roomIDInput:focus { border-color: var(--text-active); }

    /* Broadcast Status */
    #broadcast-status h2 { color: var(--success-color); }
    #room-code-display {
        font-family: 'Roboto Mono', monospace;
        font-size: 3.5rem;
        font-weight: 700;
        letter-spacing: 8px;
        color: var(--text-active);
        background-color: var(--bg-code);
        padding: 16px 24px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        display: inline-block;
        margin-bottom: 16px;
    }

    /* Video Display */
    .video-display-container {
        display: none;
        width: 100%;
        height: 100%;
        padding: 24px;
        gap: 24px;
        grid-template-columns: 1fr;
    }
    .video-display-container.active { display: grid; }
    
    @media (min-width: 768px) {
      .video-display-container.has-local { grid-template-columns: 3fr 1fr; }
    }


    .video-wrapper {
      background-color: #000;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-wrapper video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    #local-video-wrapper {
        display: none; /* Hide until broadcast starts */
    }

    /* Fullscreen Mode */
    body.fullscreen-mode .main-header { display: none; }
    body.fullscreen-mode .content-area { padding: 0; }

  </style>
</head>
<body>

  <div class="app-container">
    <header class="main-header">
      <h1 class="header-title">WebRTC Screen Share</h1>
    </header>

    <main class="content-area">
      <div id="controlsWrapper" class="content-wrapper">
        <!-- Initial Controls -->
        <div id="initial-controls" class="controls-container">
          <h2>Start or Join a Broadcast</h2>
          <p>Share your screen securely with a unique room code.</p>
          <div class="button-group">
            <button id="startBroadcastBtn" class="btn btn-primary">Start Broadcast</button>
            <button id="showJoinUIBtn" class="btn btn-secondary">Join a Broadcast</button>
          </div>
        </div>

        <!-- Join Controls -->
        <div id="join-controls" class="controls-container">
          <h2>Join Broadcast</h2>
          <p>Enter the 4-digit code provided by the broadcaster.</p>
          <div class="input-group">
            <input type="text" id="roomIDInput" maxlength="4" placeholder="----">
          </div>
          <div class="button-group">
            <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
            <button id="backBtn" class="btn btn-secondary">Back</button>
          </div>
        </div>
        
        <!-- Broadcast Status -->
        <div id="broadcast-status" class="controls-container">
          <h2 style="color: var(--success-color);">Your Screen Is Now Shared!</h2>
          <p>Share this code with your viewer:</p>
          <div id="room-code-display">----</div>
          <p style="color: var(--text-secondary); font-size: 0.9rem;">The broadcast will end when you stop sharing or close this window.</p>
        </div>
      </div>
      
      <div id="videoDisplay" class="video-display-container">
        <div id="remote-video-wrapper" class="video-wrapper">
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        <div id="local-video-wrapper" class="video-wrapper">
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    // --- Firebase and WebRTC Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCRsnVjim97dV4CK9tunmrSeWYGjltwEh4",
      authDomain: "instact-5ce80.firebaseapp.com",
      databaseURL: "https://instact-5ce80-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "instact-5ce80",
      storageBucket: "instact-5ce80.firebasestorage.app",
      messagingSenderId: "32031411277",
      appId: "1:32031411277:web:25eab6a5737df431cc6004"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

    // --- DOM Element References ---
    const initialControls = document.getElementById('initial-controls');
    const joinControls = document.getElementById('join-controls');
    const broadcastStatus = document.getElementById('broadcast-status');
    const controlsWrapper = document.getElementById('controlsWrapper');
    const videoDisplay = document.getElementById('videoDisplay');

    const startBroadcastBtn = document.getElementById('startBroadcastBtn');
    const showJoinUIBtn = document.getElementById('showJoinUIBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const backBtn = document.getElementById('backBtn');
    
    const roomIDInput = document.getElementById('roomIDInput');
    const roomCodeDisplay = document.getElementById('room-code-display');

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideoWrapper = document.getElementById('local-video-wrapper');
    const remoteVideoWrapper = document.getElementById('remote-video-wrapper');

    let pc;
    let localStream;
    let roomId;
    
    // --- UI State Management ---
    function switchUIMode(mode) {
      initialControls.style.display = 'none';
      joinControls.style.display = 'none';
      controlsWrapper.style.display = 'none';
      videoDisplay.classList.remove('active', 'has-local');
      document.body.classList.remove('fullscreen-mode');

      if (mode === 'initial') {
        controlsWrapper.style.display = 'block';
        initialControls.style.display = 'block';
      } else if (mode === 'join') {
        controlsWrapper.style.display = 'block';
        joinControls.style.display = 'block';
      } else if (mode === 'broadcasting') {
        document.body.classList.add('fullscreen-mode');
        videoDisplay.classList.add('active', 'has-local');
        controlsWrapper.style.display = 'block';
        broadcastStatus.style.display = 'block';
        remoteVideoWrapper.style.display = 'none'; // Host doesn't see remote
        localVideoWrapper.style.display = 'flex';
        videoDisplay.style.gridTemplateColumns = '1fr'; // Only show local
      } else if (mode === 'viewing') {
        document.body.classList.add('fullscreen-mode');
        videoDisplay.classList.add('active');
        localVideoWrapper.style.display = 'none';
      }
    }

    showJoinUIBtn.onclick = () => switchUIMode('join');
    backBtn.onclick = () => switchUIMode('initial');

    // --- Host/Broadcaster Logic ---
    startBroadcastBtn.onclick = async () => {
      startBroadcastBtn.disabled = true;
      roomId = Math.floor(1000 + Math.random() * 9000).toString();
      roomCodeDisplay.textContent = roomId;
      
      pc = new RTCPeerConnection(servers);

      try {
        localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        switchUIMode('broadcasting');

        const roomRef = ref(database, `rooms/${roomId}`);
        await remove(roomRef); // Clean up previous room data if any
        onDisconnect(roomRef).remove();

        const offerCandidates = ref(database, `rooms/${roomId}/offerCandidates`);
        const answerCandidates = ref(database, `rooms/${roomId}/answerCandidates`);
        
        pc.onicecandidate = event => event.candidate && push(offerCandidates, event.candidate.toJSON());
        
        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);
        
        const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
        await set(ref(database, `rooms/${roomId}/offer`), offer);

        onValue(ref(database, `rooms/${roomId}/answer`), async (snapshot) => {
          if (snapshot.exists() && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(snapshot.val()));
          }
        });
        
        onValue(answerCandidates, (snapshot) => {
          snapshot.forEach(child => pc.addIceCandidate(new RTCIceCandidate(child.val())));
        });

        localStream.getVideoTracks()[0].onended = () => {
          alert("Screen sharing has ended.");
          window.location.reload();
        };

      } catch (err) {
        console.error("Error starting broadcast:", err);
        alert("Failed to start screen share. Please grant permissions.");
        window.location.reload();
      }
    };

    // --- Viewer/Joiner Logic ---
    joinRoomBtn.onclick = async () => {
      roomId = roomIDInput.value;
      if (!roomId || roomId.length !== 4) {
        alert("Please enter a valid 4-digit room code.");
        return;
      }
      joinRoomBtn.disabled = true;

      pc = new RTCPeerConnection(servers);
      pc.ontrack = event => remoteVideo.srcObject = event.streams[0];
      
      const roomRef = ref(database, `rooms/${roomId}`);
      const offerRef = ref(database, `rooms/${roomId}/offer`);
      const offerSnapshot = await get(offerRef);

      if (!offerSnapshot.exists()) {
        alert("Room not found. Please check the code.");
        window.location.reload();
        return;
      }

      switchUIMode('viewing');
      
      const offerCandidates = ref(database, `rooms/${roomId}/offerCandidates`);
      const answerCandidates = ref(database, `rooms/${roomId}/answerCandidates`);

      pc.onicecandidate = event => event.candidate && push(answerCandidates, event.candidate.toJSON());

      await pc.setRemoteDescription(new RTCSessionDescription(offerSnapshot.val()));
      
      const answerDescription = await pc.createAnswer();
      await pc.setLocalDescription(answerDescription);

      const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
      await set(ref(database, `rooms/${roomId}/answer`), answer);
      
      onValue(offerCandidates, (snapshot) => {
        snapshot.forEach(child => pc.addIceCandidate(new RTCIceCandidate(child.val())));
      });
    };

  </script>
</body>
</html>
